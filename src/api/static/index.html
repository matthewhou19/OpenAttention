<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AttentionOS</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242736;
    --border: #2e3144;
    --text: #e4e4e7;
    --text2: #a1a1aa;
    --accent: #6366f1;
    --accent2: #818cf8;
    --green: #22c55e;
    --yellow: #eab308;
    --red: #ef4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- Header --- */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .header h1 { font-size: 18px; font-weight: 600; }

  .view-toggle {
    display: flex;
    gap: 2px;
    background: var(--surface2);
    border-radius: 6px;
    padding: 2px;
  }

  .view-toggle button {
    background: transparent;
    border: none;
    color: var(--text2);
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }

  .view-toggle button.active {
    background: var(--accent);
    color: white;
  }

  .view-toggle button:hover:not(.active) { color: var(--text); }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .stats {
    display: flex;
    gap: 14px;
    font-size: 12px;
    color: var(--text2);
  }

  .stats span { display: flex; align-items: center; gap: 3px; }
  .stats .num { color: var(--accent2); font-weight: 600; }

  .filters {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .filters select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 12px;
  }

  .filters select:focus { outline: none; border-color: var(--accent); }

  .filters label {
    font-size: 10px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: -4px;
  }

  /* --- Columns layout (Classic view) --- */
  .board {
    flex: 1;
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 16px 12px;
    gap: 12px;
    scroll-behavior: smooth;
  }

  .board::-webkit-scrollbar { height: 6px; }
  .board::-webkit-scrollbar-track { background: var(--bg); }
  .board::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .column {
    min-width: 340px;
    max-width: 380px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .column-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .col-icon {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .col-name {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
  }

  .col-count {
    font-size: 11px;
    color: var(--text2);
    background: var(--surface2);
    padding: 1px 7px;
    border-radius: 8px;
    margin-left: auto;
  }

  .column-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .column-body::-webkit-scrollbar { width: 4px; }
  .column-body::-webkit-scrollbar-track { background: transparent; }
  .column-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* --- For You feed layout --- */
  .feed {
    flex: 1;
    overflow-y: auto;
    padding: 16px 0;
  }

  .feed::-webkit-scrollbar { width: 6px; }
  .feed::-webkit-scrollbar-track { background: var(--bg); }
  .feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .feed-inner {
    max-width: 640px;
    margin: 0 auto;
    padding: 0 16px;
  }

  /* --- Article cards --- */
  .article-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 8px;
    transition: border-color 0.15s;
  }

  .article-card:hover { border-color: var(--accent); }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 4px;
  }

  /* For You card title is bigger */
  .feed .card-title { font-size: 15px; margin-bottom: 6px; }

  .card-title a { color: var(--text); text-decoration: none; }
  .card-title a:hover { color: var(--accent2); }

  .card-scores {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
  }

  .score-pill {
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 4px;
    background: var(--surface);
  }

  .score-pill.high { color: var(--green); }
  .score-pill.mid { color: var(--yellow); }
  .score-pill.low { color: var(--red); }

  .card-summary {
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 8px;
    line-height: 1.4;
  }

  .feed .card-summary { font-size: 13px; margin-bottom: 10px; }

  .card-topics {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }

  .topic-chip {
    font-size: 10px;
    padding: 1px 8px;
    border-radius: 10px;
    font-weight: 500;
    white-space: nowrap;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
  }

  .card-meta {
    display: flex;
    gap: 5px;
    align-items: center;
    flex-wrap: wrap;
    min-width: 0;
  }

  .source-tag {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 3px;
    background: var(--accent);
    color: white;
    font-weight: 500;
    white-space: nowrap;
  }

  .date-text { font-size: 10px; color: var(--text2); white-space: nowrap; }

  .feedback-btns {
    display: flex;
    gap: 3px;
    flex-shrink: 0;
  }

  .feedback-btns button {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 2px 7px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    transition: all 0.15s;
  }

  .feedback-btns button:hover { border-color: var(--accent); color: var(--text); }
  .feedback-btns button.active-like { background: #166534; border-color: var(--green); color: white; }
  .feedback-btns button.active-dislike { background: #7f1d1d; border-color: var(--red); color: white; }
  .feedback-btns button.active-save { background: #854d0e; border-color: var(--yellow); color: white; }

  .empty-state {
    text-align: center;
    padding: 40px 16px;
    color: var(--text2);
    font-size: 13px;
  }

  .loading { text-align: center; padding: 40px; color: var(--text2); }

  .load-more {
    text-align: center;
    padding: 16px;
  }

  .load-more button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 8px 24px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
  }

  .load-more button:hover { border-color: var(--accent); color: var(--text); }

  /* --- Action bar --- */
  .actions {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .actions button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-weight: 500;
    white-space: nowrap;
  }

  .actions button:hover { opacity: 0.9; }
  .actions button:disabled { opacity: 0.5; cursor: not-allowed; }

  .actions input {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    width: 260px;
  }

  .actions input::placeholder { color: var(--text2); }
  .actions input:focus { outline: none; border-color: var(--accent); }

  .actions .add-btn { background: var(--green); }
  .actions .section-btn { background: var(--yellow); color: #1a1d27; }
  .actions .divider { width: 1px; height: 20px; background: var(--border); }

  .actions select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
  }
  .actions select:focus { outline: none; border-color: var(--accent); }

  #actionStatus {
    font-size: 12px;
    color: var(--text2);
    margin-left: auto;
    white-space: nowrap;
  }

  /* Classic-only filters */
  .classic-filters { display: none; }
  body.view-classic .classic-filters { display: flex; }

  /* View visibility */
  body.view-classic #feedContainer { display: none; }
  body.view-classic #board { display: flex; }
  body.view-foryou #feedContainer { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  body.view-foryou #board { display: none; }

  /* Empty column placeholder */
  .column.empty { opacity: 0.5; }
  .column.empty .column-body { display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body class="view-foryou">

<div class="header">
  <div class="header-left">
    <h1>AttentionOS</h1>
    <div class="view-toggle">
      <button class="active" onclick="switchView('foryou')" id="viewForYou">For You</button>
      <button onclick="switchView('classic')" id="viewClassic">Classic</button>
    </div>
  </div>
  <div class="header-right">
    <div class="stats" id="stats"></div>
    <div class="filters classic-filters">
      <label>Score</label>
      <select id="minScore" onchange="loadClassicArticles()">
        <option value="0">All</option>
        <option value="5">5+</option>
        <option value="7" selected>7+</option>
        <option value="8">8+</option>
        <option value="9">9+</option>
      </select>
      <label>Source</label>
      <select id="feedFilter" onchange="loadClassicArticles()">
        <option value="">All</option>
      </select>
    </div>
  </div>
</div>

<div class="actions">
  <button onclick="doFetch()" id="fetchBtn">Refresh</button>
  <div class="divider"></div>
  <input type="text" id="feedUrl" placeholder="RSS feed URL..." onkeydown="if(event.key==='Enter')doAddFeed()">
  <select id="feedSection"></select>
  <button class="add-btn" onclick="doAddFeed()">+ Add Feed</button>
  <div class="divider"></div>
  <button class="section-btn" onclick="doAddSection()">+ Section</button>
  <span id="actionStatus"></span>
</div>

<!-- For You view -->
<div id="feedContainer">
  <div class="feed" id="feed">
    <div class="feed-inner" id="feedInner">
      <div class="loading">Loading...</div>
    </div>
  </div>
</div>

<!-- Classic (kanban) view -->
<div class="board" id="board">
  <div class="loading">Loading...</div>
</div>

<script>
const API = '/api';

let TOPIC_DEFS = [];
let currentView = 'foryou';
let forYouCursor = null;
let forYouLoading = false;

// --- View switching ---

function switchView(view) {
  currentView = view;
  document.body.className = `view-${view}`;
  document.getElementById('viewForYou').classList.toggle('active', view === 'foryou');
  document.getElementById('viewClassic').classList.toggle('active', view === 'classic');
  if (view === 'foryou') {
    forYouCursor = null;
    loadForYouArticles(true);
  } else {
    loadClassicArticles();
  }
}

// --- Shared ---

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

async function loadSections() {
  const res = await fetch(`${API}/sections`);
  TOPIC_DEFS = await res.json();
  const sel = document.getElementById('feedSection');
  sel.innerHTML = '';
  for (const s of TOPIC_DEFS) {
    if (!s.visible) continue;
    const opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = `${s.icon} ${s.name}`;
    sel.appendChild(opt);
  }
}

function getTopicDef(name) {
  return TOPIC_DEFS.find(d => d.name.toLowerCase() === name.toLowerCase()) || { name, icon: '', color: '#71717a', match: [] };
}

async function loadStats() {
  const res = await fetch(`${API}/stats`);
  const data = await res.json();
  document.getElementById('stats').innerHTML = `
    <span>Feeds <span class="num">${data.feeds}</span></span>
    <span>Articles <span class="num">${data.articles}</span></span>
    <span>Scored <span class="num">${data.scored}</span></span>
  `;
}

async function loadFeeds() {
  const res = await fetch(`${API}/feeds`);
  const feeds = await res.json();
  const sel = document.getElementById('feedFilter');
  feeds.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.title || f.url;
    sel.appendChild(opt);
  });
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const now = new Date();
  const diffH = Math.floor((now - d) / 3600000);
  if (diffH < 1) return 'now';
  if (diffH < 24) return `${diffH}h`;
  if (diffH < 48) return '1d';
  const diffD = Math.floor(diffH / 24);
  if (diffD < 7) return `${diffD}d`;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function scorePillClass(val) {
  if (val >= 7) return 'high';
  if (val >= 4) return 'mid';
  return 'low';
}

async function sendFeedback(articleId, action, btn) {
  await fetch(`${API}/feedback`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ article_id: articleId, action })
  });
  const card = btn.closest('.article-card');
  card.querySelectorAll('.feedback-btns button').forEach(b => { b.className = ''; });
  btn.className = `active-${action}`;
  loadStats();
}

function setStatus(msg) {
  document.getElementById('actionStatus').textContent = msg;
}

// --- For You view ---

function renderForYouCard(a) {
  const s = a.score;
  const topicChips = (s && s.topics) ? s.topics.map(t => {
    const def = getTopicDef(t);
    return `<span class="topic-chip" style="background:${def.color}22;color:${def.color}">${escapeHtml(t)}</span>`;
  }).join('') : '';

  return `
    <div class="article-card" data-id="${a.id}">
      <div class="card-title">
        <a href="${encodeURI(a.url)}" target="_blank" rel="noopener">${escapeHtml(a.title || 'Untitled')}</a>
      </div>
      ${s && s.summary ? `<div class="card-summary">${escapeHtml(s.summary)}</div>` : ''}
      ${topicChips ? `<div class="card-topics">${topicChips}</div>` : ''}
      <div class="card-footer">
        <div class="card-meta">
          <span class="source-tag">${escapeHtml(a.feed_title)}</span>
          <span class="date-text">${formatDate(a.published_at)}</span>
        </div>
        <div class="feedback-btns">
          <button onclick="sendFeedback(${a.id},'like',this)" title="Like">+</button>
          <button onclick="sendFeedback(${a.id},'dislike',this)" title="Dislike">-</button>
          <button onclick="sendFeedback(${a.id},'save',this)" title="Save">&#9733;</button>
        </div>
      </div>
    </div>
  `;
}

async function loadForYouArticles(reset = false) {
  if (forYouLoading) return;
  forYouLoading = true;

  const inner = document.getElementById('feedInner');
  if (reset) {
    forYouCursor = null;
    inner.innerHTML = '<div class="loading">Loading...</div>';
  }

  let url = `${API}/articles?view=foryou&limit=20`;
  if (forYouCursor) url += `&cursor=${forYouCursor}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (reset) inner.innerHTML = '';

    if (data.articles.length === 0 && reset) {
      inner.innerHTML = '<div class="empty-state"><h2>Your interests are set!</h2><p>Fetching articles...</p></div>';
      forYouLoading = false;
      return;
    }

    inner.querySelectorAll('.load-more').forEach(el => el.remove());

    for (const a of data.articles) {
      inner.insertAdjacentHTML('beforeend', renderForYouCard(a));
    }

    forYouCursor = data.next_cursor;

    if (forYouCursor) {
      inner.insertAdjacentHTML('beforeend', '<div class="load-more"><button onclick="loadForYouArticles()">Load more</button></div>');
    }
  } catch (e) {
    if (reset) inner.innerHTML = `<div class="empty-state">Failed to load: ${e.message}</div>`;
  }

  forYouLoading = false;
}

// Infinite scroll for For You
document.addEventListener('DOMContentLoaded', () => {
  const feed = document.getElementById('feed');
  if (feed) {
    feed.addEventListener('scroll', () => {
      if (currentView !== 'foryou' || !forYouCursor || forYouLoading) return;
      const { scrollTop, scrollHeight, clientHeight } = feed;
      if (scrollTop + clientHeight >= scrollHeight - 200) {
        loadForYouArticles();
      }
    });
  }
});

// --- Classic (kanban) view ---

function renderClassicCard(a) {
  const s = a.score;
  return `
    <div class="article-card" data-id="${a.id}">
      <div class="card-title">
        <a href="${encodeURI(a.url)}" target="_blank" rel="noopener">${escapeHtml(a.title || 'Untitled')}</a>
      </div>
      ${s ? `
      <div class="card-scores">
        <span class="score-pill ${scorePillClass(s.relevance)}">R${s.relevance}</span>
        <span class="score-pill ${scorePillClass(s.significance)}">S${s.significance}</span>
      </div>` : ''}
      ${s && s.summary ? `<div class="card-summary">${escapeHtml(s.summary)}</div>` : ''}
      <div class="card-footer">
        <div class="card-meta">
          <span class="source-tag">${escapeHtml(a.feed_title)}</span>
          <span class="date-text">${formatDate(a.published_at)}</span>
        </div>
        <div class="feedback-btns">
          <button onclick="sendFeedback(${a.id},'like',this)" title="Like">+</button>
          <button onclick="sendFeedback(${a.id},'dislike',this)" title="Dislike">-</button>
          <button onclick="sendFeedback(${a.id},'save',this)" title="Save">&#9733;</button>
        </div>
      </div>
    </div>
  `;
}

function classifyArticle(article) {
  return article.feed_category || 'Uncategorized';
}

function renderColumn(topicName, articles) {
  const def = getTopicDef(topicName);
  const isEmpty = articles.length === 0;
  return `
    <div class="column${isEmpty ? ' empty' : ''}">
      <div class="column-header">
        <div class="col-icon" style="background:${def.color}22;color:${def.color}">${def.icon}</div>
        <span class="col-name">${topicName}</span>
        <span class="col-count">${articles.length}</span>
      </div>
      <div class="column-body">
        ${isEmpty ? '<div class="empty-state">No articles</div>' : articles.map(renderClassicCard).join('')}
      </div>
    </div>
  `;
}

async function loadClassicArticles() {
  const board = document.getElementById('board');
  board.innerHTML = '<div class="loading">Loading...</div>';

  const minScore = document.getElementById('minScore').value;
  const feedId = document.getElementById('feedFilter').value;

  let url = `${API}/articles?limit=100&scored_only=true`;
  if (minScore > 0) url += `&min_score=${minScore}`;
  if (feedId) url += `&feed_id=${feedId}`;

  const res = await fetch(url);
  const articles = await res.json();

  const groups = {};
  for (const a of articles) {
    const topic = classifyArticle(a);
    if (!groups[topic]) groups[topic] = [];
    groups[topic].push(a);
  }

  const orderedNames = TOPIC_DEFS.map(d => d.name);
  const sortedTopics = Object.keys(groups).sort((a, b) => {
    const ia = orderedNames.indexOf(a);
    const ib = orderedNames.indexOf(b);
    if (ia === -1 && ib === -1) return 0;
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  if (sortedTopics.length === 0) {
    board.innerHTML = '<div class="empty-state"><h2>No articles found</h2><p>Try lowering the min score.</p></div>';
    return;
  }

  board.innerHTML = sortedTopics.map(t => renderColumn(t, groups[t])).join('');
}

// --- Actions ---

async function doFetch() {
  const btn = document.getElementById('fetchBtn');
  btn.disabled = true;
  btn.textContent = 'Fetching...';
  setStatus('Fetching & scoring (may take a minute)...');
  try {
    const res = await fetch(`${API}/fetch`, { method: 'POST' });
    const data = await res.json();
    let msg = `${data.total_new} new articles`;
    if (data.scored > 0) msg += `, ${data.scored} scored`;
    else if (data.total_new === 0) msg = 'No new articles';
    if (data.score_error) msg += ' (score error)';
    setStatus(msg);
    loadStats();
    if (currentView === 'foryou') loadForYouArticles(true);
    else loadClassicArticles();
  } catch (e) {
    setStatus('Failed: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Refresh';
  }
}

async function doAddFeed() {
  const input = document.getElementById('feedUrl');
  const url = input.value.trim();
  if (!url) return;
  const category = document.getElementById('feedSection').value;
  setStatus('Adding feed...');
  try {
    const res = await fetch(`${API}/feeds`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, category })
    });
    if (res.ok) {
      const feed = await res.json();
      setStatus(`Added: ${feed.title || feed.url}`);
      input.value = '';
      const sel = document.getElementById('feedFilter');
      const opt = document.createElement('option');
      opt.value = feed.id;
      opt.textContent = feed.title || feed.url;
      sel.appendChild(opt);
      loadStats();
    } else {
      const err = await res.json();
      setStatus('Error: ' + (err.detail || 'Failed to add feed'));
    }
  } catch (e) {
    setStatus('Add feed failed: ' + e.message);
  }
}

async function doAddSection() {
  const name = prompt('New section name:');
  if (!name || !name.trim()) return;
  const trimmed = name.trim();
  if (TOPIC_DEFS.some(d => d.name.toLowerCase() === trimmed.toLowerCase())) {
    setStatus('Section already exists');
    return;
  }
  const newSection = { name: trimmed, icon: '\u{1F4C2}', color: '#71717a', match: [], visible: true };
  const updated = [...TOPIC_DEFS, newSection];
  try {
    const res = await fetch(`${API}/sections`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updated)
    });
    if (res.ok) {
      setStatus(`Section added: ${trimmed}`);
      await loadSections();
      if (currentView === 'classic') loadClassicArticles();
    } else {
      setStatus('Failed to add section');
    }
  } catch (e) {
    setStatus('Error: ' + e.message);
  }
}

// --- Init ---

loadSections().then(() => {
  loadStats();
  loadFeeds();
  loadForYouArticles(true);
});
</script>
</body>
</html>
